name: II. Integration – Merge to Develop

on:
  pull_request:
    branches: [ develop ]
    types: [ closed ]

permissions:
  contents: read
  actions: read

concurrency:
  group: develop-integration
  cancel-in-progress: true

jobs:
  integration:
    name: Deploy & Validate (Develop)
    runs-on: ubuntu-22.04
    timeout-minutes: 60

    if: github.event.pull_request.merged == true

    steps:
      # ------------------------------------------------
      # Guardrail – feature/* only
      # ------------------------------------------------
      - name: Validate merged branch
        run: |
          echo "Merged from: ${{ github.event.pull_request.head.ref }}"
          if [[ ! "${{ github.event.pull_request.head.ref }}" =~ ^feature/ ]]; then
            echo "❌ Only feature/* merges trigger integration"
            exit 1
          fi

      # ------------------------------------------------
      # Checkout develop (scripts only)
      # ------------------------------------------------
      - uses: actions/checkout@v4

      # ------------------------------------------------
      # Setup GitHub CLI
      # ------------------------------------------------
      - name: Setup GitHub CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y gh

      - name: Authenticate gh
        run: echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      # ------------------------------------------------
      # Get latest SUCCESSFUL PR workflow run
      # ------------------------------------------------
      - name: Get PR workflow run ID
        id: pr_run
        run: |
          RUN_ID=$(gh run list \
            --repo ${{ github.repository }} \
            --workflow "I. Review – Full Stack PR Gate (Quality & Security)" \
            --json databaseId,conclusion \
            --jq '.[] | select(.conclusion=="success") | .databaseId' \
            | head -n 1)

          if [ -z "$RUN_ID" ]; then
            echo "❌ No successful PR workflow run found"
            exit 1
          fi

          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT

      # ------------------------------------------------
      # Download artifacts from PR pipeline
      # ------------------------------------------------
      - name: Download frontend artifact
        run: |
          gh run download ${{ steps.pr_run.outputs.run_id }} \
            --repo ${{ github.repository }} \
            --name pr-frontend-build-${{ github.event.pull_request.number }} \
            --dir dist/frontend

      - name: Download backend artifact
        run: |
          gh run download ${{ steps.pr_run.outputs.run_id }} \
            --repo ${{ github.repository }} \
            --name pr-backend-src-${{ github.event.pull_request.number }} \
            --dir dist/backend

      # ------------------------------------------------
      # Deploy (artifact-driven)
      # ------------------------------------------------
      - name: Deploy to develop environment
        run: |
          chmod +x scripts/deploy-dev.sh
          ./scripts/deploy-dev.sh
        env:
          FRONTEND_PATH: dist/frontend
          BACKEND_PATH: dist/backend
          DEV_API_KEY: ${{ secrets.DEV_API_KEY }}
          DEV_DB_URL: ${{ secrets.DEV_DB_URL }}

      # ------------------------------------------------
      # Post-deploy validation
      # ------------------------------------------------
      - name: Setup Node.js (for tests)
        uses: actions/setup-node@v4
        with:
          node-version: 18.19.0

      - name: Smoke tests
        run: npm run test:smoke
        working-directory: frontend

      - name: End-to-End tests
        run: npm run test:e2e
        working-directory: frontend
