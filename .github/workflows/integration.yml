name: II. Integration – Merge to Develop (Artifact Deploy)

on:
  pull_request:
    branches: [ develop ]
    types: [ closed ]

permissions:
  contents: read
  actions: read

concurrency:
  group: develop-integration
  cancel-in-progress: true

jobs:
# =================================================
# 1️⃣ INTEGRATION & DEPLOY
# =================================================
  integration:
    name: Deploy & Validate (Develop)
    runs-on: ubuntu-22.04
    timeout-minutes: 60

    # Run ONLY if PR was merged
    if: github.event.pull_request.merged == true

    steps:
# -------------------------------------------------
# Guardrail
# -------------------------------------------------
      - name: Validate merged branch
        run: |
          echo "Merged from: ${{ github.event.pull_request.head.ref }}"
          if [[ ! "${{ github.event.pull_request.head.ref }}" =~ ^feature/ ]]; then
            echo "❌ Only feature/* merges trigger integration"
            exit 1
          fi

# -------------------------------------------------
# Checkout develop (infra + scripts only)
# -------------------------------------------------
      - name: Checkout develop
        uses: actions/checkout@v4

# -------------------------------------------------
# Setup GitHub CLI (artifact access)
# -------------------------------------------------
      - name: Install GitHub CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y gh

      - name: Authenticate GitHub CLI
        run: echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

# -------------------------------------------------
# Locate successful PR pipeline run
# -------------------------------------------------
      - name: Get PR workflow run ID
        id: pr_run
        run: |
          RUN_ID=$(gh run list \
            --repo ${{ github.repository }} \
            --workflow "I. Review – Full Stack PR Gate (Quality & Security)" \
            --json databaseId,event,conclusion \
            --jq '.[] | select(.event=="pull_request" and .conclusion=="success") | .databaseId' \
            | head -n 1)

          if [ -z "$RUN_ID" ]; then
            echo "❌ No successful PR workflow run found"
            exit 1
          fi

          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT

# -------------------------------------------------
# Download FRONTEND artifact
# -------------------------------------------------
      - name: Download frontend artifact
        run: |
          gh run download ${{ steps.pr_run.outputs.run_id }} \
            --repo ${{ github.repository }} \
            --name pr-frontend-build-${{ github.event.pull_request.number }} \
            --dir dist/frontend

# -------------------------------------------------
# Download BACKEND artifact
# -------------------------------------------------
      - name: Download backend artifact
        run: |
          gh run download ${{ steps.pr_run.outputs.run_id }} \
            --repo ${{ github.repository }} \
            --name pr-backend-src-${{ github.event.pull_request.number }} \
            --dir dist/backend

# -------------------------------------------------
# Deploy to Linux server (artifact-driven)
# -------------------------------------------------
      - name: Deploy to develop server
        run: |
          chmod +x scripts/deploy-dev.sh
          bash scripts/deploy-dev.sh
        env:
          FRONTEND_PATH: dist/frontend
          BACKEND_PATH: dist/backend
          SERVER_IP: ${{ secrets.SERVER_IP }}
          SERVER_PORT: ${{ secrets.SERVER_PORT }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SERVER_PATH: ${{ secrets.SERVER_PATH }}

# -------------------------------------------------
# Post-deploy health validation
# -------------------------------------------------
      - name: Health check
        run: |
          curl --fail --retry 5 --retry-delay 5 \
          http://${{ secrets.SERVER_IP }}:8000/health
